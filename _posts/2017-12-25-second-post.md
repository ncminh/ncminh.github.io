Config SSL with Let's Encrypt for production server with a rails app

1. SSH to production server with app user ( deployer )

2. Check if **openssl** library has been installed or not with the command: `which openssl`

3. Create self-signed certificate with command:

   `openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/nginx.key -out /etc/ssl/certs/nginx.crt -batch`

4. Check the nginx config file and use the `nginx -t` command to test the config file:

   ```nginx
   # Default server configuration
   # This is just the sample file. The working file for unicorn is at the end of the post.
   server {
     listen 80 default_server;
     return 301 https://$server_addr$request_uri;
   }
   
   # SSL configuration
   #
   server {
   	listen 443 ssl default_server;
   	listen [::]:443 ssl default_server;
   
   	ssl_certificate /etc/ssl/certs/nginx.crt;
   	ssl_certificate_key /etc/ssl/private/nginx.key;
   
   	server_name example.com www.example.com;
   
       # Note: You should disable gzip for SSL traffic.
       # See: https://bugs.debian.org/773332
       #
       # Read up on ssl_ciphers to ensure a secure configuration.
       # See: https://bugs.debian.org/765782
       #
       # Self signed certs generated by the ssl-cert package
       # Don't use them in a production server!
       #
       # include snippets/snakeoil.conf;
   
       root /var/www/html;
   
       # Add index.php to the list if you are using PHP
       index index.html index.htm index.nginx-debian.html;
   
   server_name _;
   
       location / {
           # First attempt to serve request as file, then
           # as directory, then fall back to displaying a 404.
           try_files $uri $uri/ =404;
       }
   
       # pass PHP scripts to FastCGI server
       #
       #location ~ \.php$ {
       #	include snippets/fastcgi-php.conf;
       #
       #	# With php-fpm (or other unix sockets):
       #	fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
       #	# With php-cgi (or other tcp sockets):
       #	fastcgi_pass 127.0.0.1:9000;
       #}
   
       # deny access to .htaccess files, if Apache's document root
       # concurs with nginx's one
       #
       #location ~ /\.ht {
       #	deny all;
       #}
   }
   
   # Virtual Host configuration for example.com
   #
   # You can move that to a different file under sites-available/ and symlink that
   # to sites-enabled/ to enable it.
   #
   #server {
   #	listen 80;
   #	listen [::]:80;
   #
   #	server_name example.com;
   #
   #	root /var/www/example.com;
   #	index index.html;
   #
   #	location / {
   #		try_files $uri $uri/ =404;
   #	}
   #}
   
   ```

5. Install certbot: `root@server:~# sudo snap install --classic certbot`

6. Symlink the certbot command: `root@server:~# sudo ln -s /snap/bin/certbot /usr/bin/certbot`

7. Use certbot command to install SSL Certificate for the domain assigned in nginx file (example.com) :  `root@server:~# sudo certbot --nginx`

8. Login to registra website with the account and config the domain point to server's IP.

9. Verify the Let's Encrypt cert to be renewed automatically: `root@server:~# sudo certbot renew --dry-run`

10. Working nginx config file for a rails app using **unicorn** + **nginx**:

```nginx
upstream unicorn {
  server unix:/tmp/unicorn.[APP_NAME].sock fail_timeout=0;
}

server {
  client_max_body_size 4G;

  listen 80 default_server deferred;

  server_name example.com www.example.com;

  return 301 https://$server_addr$request_uri;
}

server {

  listen 443 ssl default_server;
  listen [::]:443 ssl default_server;

  ssl_certificate /etc/ssl/certs/nginx.crt;
  ssl_certificate_key /etc/ssl/private/nginx.key;
  include /etc/letsencrypt/options-ssl-nginx.conf;  # Managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;    # Managed by Certbot

  server_name example.com www.example.com;

  location ^~ /assets/ {
    gzip_static on;
    expires max;
    add_header Cache-Control public;
  }

  root /home/deployer/blog/current/public;
  try_files $uri/index.html $uri @unicorn;
  location @unicorn {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;       # Very important for SSL Configuration
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_pass http://unicorn;
  }
  error_page 500 502 503 504 /500.html;
}
```